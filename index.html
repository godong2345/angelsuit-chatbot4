<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엔젤슈트 H10 챗봇</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background-color: #121212;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #fff;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background-color: #1e1e1e;
            border-right: 1px solid #333;
            transition: transform 0.3s;
            transform: translateX(-300px);
            position: absolute;
            z-index: 10;
            height: calc(100% - 60px);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 1rem;
            margin-bottom: 1rem;
        }
        
        .message {
            display: flex;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #333;
            margin-right: 1rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .avatar-icon {
            max-width: 25px;
            max-height: 25px;
            width: 25px;
            height: 25px;
            object-fit: contain;
        }
        
        .user-message .message-avatar {
            background-color: #555;
        }
        
        .ai-message .message-avatar {
            background-color: rgba(66,125,255,1);
        }
        
        .message-content {
            max-width: 80%;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #2a2a2a;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .user-message .message-content {
            background-color: #333;
            margin-left: auto;
            order: 1;
        }
        
        .user-message .message-avatar {
            order: 2;
            margin-right: 0;
            margin-left: 1rem;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: #aaa;
            font-size: 0.85rem;
        }
        
        .message-image {
            margin-top: 10px;
            border-radius: 4px;
            overflow: hidden;
            text-align: center;
        }
        
        .message-image img {
            max-width: 100%;
            display: block;
            border-radius: 4px;
            margin: 0 auto;
        }
        
        /* 착용방법 이미지 특별 스타일 */
        .wearing-guide-image {
            max-width: 100% !important;
            width: auto !important;
            height: auto !important;
            min-height: 250px !important;
            max-height: 80vh !important;
            object-fit: contain !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            margin: 10px auto !important;
            cursor: pointer !important; /* 클릭 가능함을 표시 */
        }
        
        /* 모바일에서의 이미지 스타일 */
        @media (max-width: 768px) {
            .wearing-guide-image {
                min-height: 200px !important;
                max-height: 70vh !important;
            }
        }
        
        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .message-actions button {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background-color 0.3s;
        }
        
        .message-actions button:hover {
            background-color: #444;
        }
        
        .chat-form {
            display: flex;
            gap: 0.5rem;
            padding: 0.8rem;
            background-color: #2a2a2a;
            border-radius: 1rem;
            align-items: center;
            margin-top: 1rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background-color: transparent;
            color: #fff;
            outline: none;
            height: 20px;
            border-radius: 20px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .chat-form button {
            background-color: rgba(66,125,255,1);
            border: none;
            color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .chat-form button:hover {
            background-color: rgba(40,90,230,1);
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .header-actions button {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .header-actions button:hover {
            background-color: #333;
        }
        
        .menu-button {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            margin-right: 0.5rem;
        }
        
        .menu-button:hover {
            background-color: #333;
        }
        
        /* 추가: 반응형 디자인 */
        @media (max-width: 768px) {
            .message {
                margin-bottom: 1rem;
            }
            
            .message-content {
                max-width: 85%;
                padding: 0.75rem;
            }
            
            .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            .sidebar {
                width: 280px;
                transform: translateX(-280px);
            }
            
            .chat-form {
                padding: 0.5rem;
            }
            
            .chat-input {
                padding: 0.5rem 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .message-content {
                max-width: 90%;
                padding: 0.6rem;
                font-size: 0.95rem;
            }
            
            .message-avatar {
                width: 30px;
                height: 30px;
                margin-right: 0.5rem;
            }
            
            .avatar-icon {
                max-width: 20px !important;
                max-height: 20px !important;
                width: 20px !important;
                height: 20px !important;
            }
            
            .user-message .message-avatar {
                margin-left: 0.5rem;
            }
            
            .chat-container {
                padding: 0.5rem;
            }
            
            .header-actions button, 
            .menu-button {
                width: 35px;
                height: 35px;
            }
            
            h1 {
                font-size: 1.1rem;
            }
            
            header {
                padding: 0.75rem;
            }
            
            .chat-form {
                margin-top: 0.5rem;
            }
            
            .chat-input {
                font-size: 13px;
            }
            
            .chat-form button {
                width: 35px;
                height: 35px;
            }
        }
        
        /* 푸터 영역 스타일 */
        footer {
            text-align: center;
            font-size: 0.8em;
            color: #777;
            margin-top: 20px;
        }
        
        /* 입력 필드 포커스 시 테두리 스타일 */
        #message-input:focus {
            border-color: rgba(66,125,255,1);
            box-shadow: 0 0 0 2px rgba(66,125,255,0.2);
        }
        
        .wearing-guide-text {
            text-align: center;
            color: #888;
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .manual-link {
            display: inline-block;
            background-color: #6C63FF;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            margin: 10px 0;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .manual-link:hover {
            background-color: #5A52E0;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <header>
        <button class="menu-button" id="menuButton">
            <span class="material-icons">menu</span>
        </button>
        <h1>엔젤슈트 H10 챗봇</h1>
        <div class="header-actions">
            <button class="search-button">
                <span class="material-icons">search</span>
            </button>
            <button class="settings-button">
                <span class="material-icons">settings</span>
            </button>
        </div>
    </header>
    
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="model-selector">
            <!-- 사이드바 내용 -->
        </aside>
        
        <div class="chat-container">
            <div id="chat-messages" class="messages"></div>
            
            <form id="chat-form" class="chat-form">
                <input type="text" id="message-input" class="chat-input" placeholder="엔젤슈트 H10에 대해 질문하세요." autofocus>
                <button type="submit" id="send-button">
                    <span class="material-icons">send</span>
                </button>
            </form>
        </div>
    </div>
    
    <script>
        // DOM 요소
        const menuButton = document.querySelector('.menu-button');
        const sidebar = document.getElementById('sidebar');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('chat-messages');
        
        // 디버그 모드
        const DEBUG_MODE = true;
        
        // API 연결 설정
        const API_URL = 'http://localhost:1234/v1/chat/completions';
        const API_HEADERS = {
            'Content-Type': 'application/json'
        };
        
        // LM Studio 연결 상태
        window.LM_STUDIO_CONNECTED = true;
        
        // 사용 가능한 모델 목록
        window.AVAILABLE_MODELS = ["llama"];
        window.WORKING_MODEL = "llama";
        
        // 질문 및 답변 데이터를 저장할 변수
        let qaPairs = [];
        
        // JSON 파일에서 Q&A 데이터 로드
        async function loadQAData() {
            try {
                // 직접 JSON 데이터 포함
                const data = [
                  {
                    "question": "엔젤슈트 H10은 어떤 제품인가요?",
                    "answer": "엔젤슈트 H10은 일상 복귀를 목표로 하는 사용자의 보행 재활 훈련을 돕기 위해 개발된 착용형 로봇입니다.",
                    "image": null,
                    "category": "기본 정보"
                  },
                  {
                    "question": "엔젤슈트 H10의 주된 사용 목적은 무엇인가요?",
                    "answer": "근육 재건 및 관절 운동 범위 회복을 목적으로 사용됩니다.",
                    "image": null,
                    "category": "기본 정보"
                  },
                  {
                    "question": "엔젤슈트 H10은 의료기기인가요?",
                    "answer": "네, 의료기기(제인 25-4093호)로 분류됩니다.",
                    "image": null,
                    "category": "기본 정보"
                  },
                  {
                    "question": "엔젤슈트 H10은 어떤 환경에서 사용해야 하나요?",
                    "answer": "병원 등 실내의 평탄하고 안정적인 바닥 환경에서 사용해야 합니다.",
                    "image": null,
                    "category": "기본 정보"
                  },
                  {
                    "question": "엔젤슈트 H10 사용 시 가장 중요한 안전 수칙은 무엇인가요?",
                    "answer": "반드시 의사의 처방 및 지도 하에, 전문가(예: 물리치료사)의 관리 감독 하에서만 사용해야 합니다.",
                    "image": null,
                    "category": "안전 주의사항"
                  },
                  {
                    "question": "제품 사용 중 넘어질 위험은 없나요?",
                    "answer": "예기치 못한 상황에서 환자가 넘어질 수 있으므로 항상 주의해야 하며, 감독자의 보조가 필요합니다.",
                    "image": null,
                    "category": "안전 주의사항"
                  },
                  {
                    "question": "제품을 임의로 분해하거나 수리해도 되나요?",
                    "answer": "절대 안 됩니다. 임의 분해, 수리, 개조는 금지되어 있으며, 고장 시 제조사에 문의해야 합니다.",
                    "image": null,
                    "category": "안전 주의사항"
                  },
                  {
                    "question": "엔젤슈트 H10 착용 시 어떤 옷을 입는 것이 좋은가요?",
                    "answer": "땀 흡수가 잘 되는 가볍고 편안한 운동복 착용을 권장합니다. 두꺼운 옷은 피해주세요.",
                    "image": null,
                    "category": "안전 주의사항"
                  },
                  {
                    "question": "엔젤슈트 H10의 기본 구성품은 무엇인가요?",
                    "answer": "엔젤슈트 H10의 기본 구성품은 다음과 같습니다:\n\n• 본체(하드웨어): 구동부, 센서, 제어장치 포함\n• 배터리 2개(본체 내장 1개, 여분 1개)\n• 충전 스테이션\n• 전원 어댑터\n• 어깨 벨트\n• 허리 벨트\n• 다리 패드(좌/우)\n• 사용설명서 및 퀵 가이드",
                    "image": null,
                    "category": "제품 구성"
                  },
                  {
                    "question": "구동부(액추에이터)는 어떤 역할을 하나요?",
                    "answer": "사용자의 고관절 움직임을 보조하는 힘을 생성하는 핵심 부품입니다.",
                    "image": null,
                    "category": "제품 구성"
                  },
                  {
                    "question": "상태 표시 LED를 통해 무엇을 알 수 있나요?",
                    "answer": "보조 레벨, 배터리 잔량, 작동 모드, 오류 상태, 블루투스 연결 상태 등을 시각적으로 확인할 수 있습니다.",
                    "image": null,
                    "category": "제품 구성"
                  },
                  {
                    "question": "엔젤슈트 H10의 무게는 얼마인가요?",
                    "answer": "배터리를 포함하여 약 4.5kg입니다.",
                    "image": null,
                    "category": "제품 구성"
                  },
                  {
                    "question": "엔젤슈트 H10 착용 전에 무엇을 준비해야 하나요?",
                    "answer": "모든 버클과 스트랩을 풀고, 골반 너비 조절 잠금을 해제한 후, 배터리가 충분히 충전되었는지 확인합니다.",
                    "image": null,
                    "category": "착용 및 사용법"
                  },
                  {
                    "question": "엔젤슈트 H10은 어떻게 착용하나요?",
                    "answer": "1. 모든 스트랩을 풀고 골반 너비를 조절합니다.\n2. 허리 스트랩을 골반에 단단히 고정합니다.\n3. 허벅지 부착부의 마그네틱 버클을 채우고 스트랩을 조입니다.\n4. 전원 버튼을 3초 이상 길게 눌러 전원을 켭니다.\n5. 앱과 연결하여 모드를 설정합니다.\n\n<a href='https://youtu.be/x0eOLwfj0ug' target='_blank' class='manual-link'>착용 방법 동영상 보기</a>",
                    "image": "qa/wearing_guide.png",
                    "category": "착용 및 사용법"
                  },
                  {
                    "question": "전원은 어떻게 켜나요?",
                    "answer": "전원/비상 버튼을 3초 이상 길게 누르면 '띵동' 소리와 함께 전원이 켜집니다.",
                    "image": null,
                    "category": "착용 및 사용법"
                  },
                  {
                    "question": "보행 보조 모드는 어떻게 시작하나요?",
                    "answer": "전원/비상 버튼을 빠르게 두 번 누르면 음성 안내와 함께 보행 보조 모드(흰색 LED)가 시작됩니다.",
                    "image": null,
                    "category": "착용 및 사용법"
                  },
                  {
                    "question": "보조력(어시스트 레벨)은 어떻게 조절하나요?",
                    "answer": "본체의 보조력 조절 버튼(+,-)을 사용하거나, 연결된 앱(angel'a PRO)을 통해 1~10단계로 조절할 수 있습니다.",
                    "image": null,
                    "category": "착용 및 사용법"
                  },
                  {
                    "question": "비상 상황 시 기기를 즉시 멈추려면 어떻게 해야 하나요?",
                    "answer": "전원/비상 버튼을 짧게 한 번 누르면 즉시 모든 보조 기능이 정지됩니다.",
                    "image": null,
                    "category": "착용 및 사용법"
                  },
                  {
                    "question": "제품 탈착은 어떻게 하나요?",
                    "answer": "착용의 역순으로 허벅지 버클, 허리 버클 순서로 풀고 골반 너비를 넓혀 벗습니다.",
                    "image": null,
                    "category": "착용 및 사용법"
                  },
                  {
                    "question": "배터리는 언제 충전해야 하나요?",
                    "answer": "기기 상태 표시 LED의 배터리 표시등이 빨간색 1칸이거나 깜빡일 때 즉시 교체하고 충전해야 합니다.",
                    "image": "qa/battery_charging.png",
                    "category": "배터리 및 충전"
                  },
                  {
                    "question": "배터리 완충까지 시간은 얼마나 걸리나요?",
                    "answer": "약 90분 정도 소요됩니다.",
                    "image": null,
                    "category": "배터리 및 충전"
                  },
                  {
                    "question": "배터리를 한 번 충전하면 얼마나 사용할 수 있나요?",
                    "answer": "평균적으로 약 120분(2시간) 사용 가능하나, 보조 레벨이나 사용 환경에 따라 달라질 수 있습니다.",
                    "image": null,
                    "category": "배터리 및 충전"
                  },
                  {
                    "question": "배터리 충전 상태는 어떻게 확인하나요?",
                    "answer": "충전 스테이션의 LED 색상으로 확인합니다. 빨간색은 충전 중, 녹색은 충전 완료를 나타냅니다.",
                    "image": null,
                    "category": "배터리 및 충전"
                  },
                  {
                    "question": "angel'a PRO 앱은 무엇을 하는 앱인가요?",
                    "answer": "엔젤슈트 H10과 연동하여 훈련 설정, 실시간 모니터링, 동작 분석, 기록 관리 등을 수행하는 전문가용 앱입니다.",
                    "image": null,
                    "category": "앱 연동"
                  },
                  {
                    "question": "제품 표면은 어떻게 닦아야 하나요?",
                    "answer": "부드러운 천에 물이나 중성세제를 약간 묻혀 닦아내고, 필요시 소독용 에탄올로 소독합니다.",
                    "image": null,
                    "category": "관리 및 유지보수"
                  },
                  {
                    "question": "엔젤슈트 H10의 품질 보증 기간은 얼마나 되나요?",
                    "answer": "본체는 구매일로부터 2년, 소모품(배터리, 어패럴)은 1년입니다.",
                    "image": null,
                    "category": "보증 및 A/S"
                  },
                  {
                    "question": "A/S 신청은 어떻게 하나요?",
                    "answer": "엔젤로보틱스 고객센터나 카카오톡 채널을 통해 문의 및 접수할 수 있습니다.",
                    "image": null,
                    "category": "보증 및 A/S"
                  },
                  {
                    "question": "사용설명서는 어디서 볼 수 있나요?",
                    "answer": "엔젤슈트 H10의 사용설명서는 다음 링크에서 다운로드하실 수 있습니다:\n\n<a href='qa/h10_manual.pdf' target='_blank' class='manual-link'>엔젤슈트 H10 사용설명서 다운로드</a>",
                    "image": null,
                    "category": "제품 구성"
                  },
                  {
                    "question": "구성품",
                    "answer": "엔젤슈트 H10의 기본 구성품은 다음과 같습니다:\n\n• 본체(하드웨어): 구동부, 센서, 제어장치 포함\n• 배터리 2개(본체 내장 1개, 여분 1개)\n• 충전 스테이션\n• 전원 어댑터\n• 어깨 벨트\n• 허리 벨트\n• 다리 패드(좌/우)\n• 사용설명서 및 퀵 가이드",
                    "image": null,
                    "category": "제품 구성"
                  },
                  {
                    "question": "사용설명서",
                    "answer": "엔젤슈트 H10의 사용설명서는 다음 링크에서 다운로드하실 수 있습니다:\n\n<a href='qa/h10_manual.pdf' target='_blank' class='manual-link'>엔젤슈트 H10 사용설명서 다운로드</a>",
                    "image": null,
                    "category": "제품 구성"
                  }
                ];
                
                console.log('JSON 데이터 로드 완료, 항목 수:', data.length);
                
                qaPairs = data.map(item => {
                    // 키워드 생성 - JSON 파일에 키워드가 없는 경우 자동 생성
                    let keywords = item.keywords;
                    if (!keywords || !Array.isArray(keywords) || keywords.length === 0) {
                        // 질문에서 주요 단어 추출 (2글자 이상, 불용어 제외)
                        const stopWords = ['은', '는', '이', '가', '을', '를', '에', '에서', '의', '로', '으로', '와', '과', '이나', '나', '및', '또는'];
                        const questionWords = item.question.toLowerCase().replace(/[?!.,]/g, '').split(/\s+/);
                        keywords = questionWords.filter(word => 
                            word.length >= 2 && !stopWords.includes(word)
                        );
                        
                        // 카테고리도 키워드에 추가
                        if (item.category && !keywords.includes(item.category)) {
                            keywords.push(item.category);
                        }
                    }
                    
                    // 이미지 경로 확인 및 처리
                    const imageLog = item.image ? `${item.image}` : '이미지 없음';
                    if (DEBUG_MODE) console.log(`QA 항목 로드: ${item.question} (이미지: ${imageLog})`);
                    
                    return {
                        question: item.question,
                        keywords: keywords,
                        answer: item.answer,
                        image: item.image || null,
                        category: item.category || null
                    };
                });
                
                console.log('Q&A 데이터 로드 완료:', qaPairs.length + '개 항목');
            } catch (error) {
                console.error('Q&A 데이터 로드 오류:', error);
                alert('질문-답변 데이터를 불러오는데 실패했습니다. 기본 데이터를 사용합니다.');
                
                // 기본 질문-답변 데이터 사용
                qaPairs = [
                    {
                        question: "엔젤슈트 H10은 어떤 제품인가요?",
                        keywords: ["주요", "기능", "기능은", "뭐", "뭔가", "무엇", "어떤"],
                        answer: "엔젤슈트 H10은 일상 복귀를 목표로 하는 사용자의 보행 재활 훈련을 돕기 위해 개발된 착용형 로봇입니다."
                    }
                    // 기존 기본 QA 페어...
                ];
            }
        }
        
        // 페이지 로드 시 QA 데이터 로드 및 환영 메시지 표시
        document.addEventListener('DOMContentLoaded', async function() {
            await loadQAData();
            addMessage("안녕하세요! 엔젤슈트 H10에 대해 어떤 것이 궁금하신가요? 기본 정보, 안전 주의사항, 제품 구성, 착용 및 사용법, 배터리 및 충전, 앱 연동, 관리 및 유지보수, 보증 및 A/S 등에 대해 질문해 보세요.", true);
        });
        
        // 메뉴 버튼 이벤트
        menuButton.addEventListener('click', function() {
            sidebar.classList.toggle('open');
        });
        
        // 영어 응답을 한국어처럼 변환하는 함수
        function koreanizeResponse(text) {
            // 영어 응답인지 확인 (한글 비율이 낮은지 체크)
            const koreanChars = text.match(/[가-힣]/g) || [];
            const totalChars = text.replace(/\s/g, '').length;
            const koreanRatio = totalChars > 0 ? koreanChars.length / totalChars : 0;
            
            // 30% 미만의 한글 비율이면 영어 응답으로 간주
            const isEnglish = koreanRatio < 0.3;
            
            if (isEnglish) {
                // 시스템 프롬프트의 영어 응답 감지 및 기본 응답으로 대체
                if (text.toLowerCase().includes("sorry") || 
                    text.toLowerCase().includes("i cannot") || 
                    text.toLowerCase().includes("i don't know") ||
                    text.toLowerCase().includes("i apologize")) {
                    return {
                        text: "죄송합니다. 질문에 대한 정확한 정보를 제공할 수 없습니다. 다른 질문을 해주시거나 더 구체적으로 질문해 주세요.",
                        isEnglish: true
                    };
                }
                
                // 언어 감지 로그
                if (DEBUG_MODE) console.log(`영어 응답 감지: 한글 비율 ${(koreanRatio * 100).toFixed(1)}%`);
            }
            
            // 그 외의 경우 그대로 반환
            return { text, isEnglish: false };
        }

        function addMessage(text, isAI, image = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isAI ? 'ai-message' : 'user-message'}`;
            
            // 로딩 메시지 식별자 추가
            if (text === "응답을 생성하는 중...") {
                messageDiv.classList.add('loading-message');
            }
            
            // 이미지 URL 처리
            let imageHTML = '';
            if (image) {
                console.log(`이미지 URL 처리: ${image}`);
                let imgSrc = image;
                
                // 착용방법 이미지인지 확인
                const isWearingGuide = imgSrc.includes('wearing_guide');
                
                // 이미지 경로 확인 및 오류 처리 추가
                imageHTML = `
                    <div class="message-image" style="margin-top: 15px; text-align: center;">
                        <img src="${imgSrc}" alt="참고 이미지" 
                            class="${isWearingGuide ? 'wearing-guide-image' : ''}"
                            style="max-width: 100%; ${isWearingGuide ? 'min-height: 250px;' : 'max-height: 300px;'} border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"
                            onclick="${isWearingGuide ? 'window.open(this.src, \'_blank\')' : ''}"
                            onerror="console.error('이미지 로드 실패: ${imgSrc}'); this.style.display='none'; this.parentNode.innerHTML='<div style=\\'font-size: 0.9em; color: #888; margin: 10px 0\\'>이미지를 불러올 수 없습니다.</div>'">
                        ${isWearingGuide ? '<div style="font-size: 0.95em; color: #555; margin-top: 10px; text-align: center; font-weight: 500;">👆 자세한 착용방법 (이미지를 클릭하면 크게 볼 수 있습니다)</div>' : ''}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${isAI ? '<img src="images/icons/symbol.svg" alt="AI" width="25" height="25" class="avatar-icon">' : '<span class="material-icons">person</span>'}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span>${isAI ? 'Angel Assistant' : 'You'}</span>
                    </div>
                    <div class="message-text">${text.replace(/\n/g, '<br>')}</div>
                    ${imageHTML}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 메시지 요소 반환하여 나중에 참조할 수 있도록 함
            return messageDiv;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;
            
            // 사용자 메시지 추가
            addMessage(message);
            
            // 입력창 비우기
            messageInput.value = '';
            
            // 입력 필드에 포커스 돌려주기
            messageInput.focus();
            
            try {
                // 입력 메시지 정규화
                const userInput = message.toLowerCase().replace(/[?!.,]/g, '').trim();
                
                // 직접 응답이 가능한 경우 (중요 키워드 기반)
                let directAnswer = null;
                
                // 인사말
                if (userInput.includes('안녕') || userInput.includes('하이') || userInput.includes('반가')) {
                    directAnswer = "안녕하세요! 엔젤슈트 H10에 대해 무엇이 궁금하신가요?";
                }
                
                // 홈페이지 관련 질문에 즉시 응답
                else if (userInput.includes('홈페이지') || userInput.includes('웹사이트') || userInput.includes('사이트') || 
                    userInput.includes('주소') || userInput.includes('url') || userInput.includes('접속') || 
                    (userInput.includes('어디') && (userInput.includes('가') || userInput.includes('보') || userInput.includes('찾')))) {
                    directAnswer = "엔젤로보틱스 공식 홈페이지 주소는 https://www.angel-robotics.com/ko 입니다. 홈페이지에서 제품 정보, 구매 안내, 고객 지원 등 다양한 정보를 확인하실 수 있습니다.";
                }
                
                // 간단한 질문 패턴 인식 - 핵심 주제별로 매칭
                else {
                    // 간단한 질문 패턴별 매핑
                    const simplePatterns = [
                        { 
                            keywords: ['무게', '몇키로', '얼마나 무거', '무게는', '얼마나 나가', '몇kg', '무게가'], 
                            question: "엔젤슈트 H10의 무게는 얼마인가요?" 
                        },
                        { 
                            keywords: ['가격', '비용', '얼마', '금액', '구매', '살', '구입'], 
                            question: "가격이 얼마인가요?" 
                        },
                        { 
                            keywords: ['배터리', '충전', '전원', '얼마나 사용'], 
                            question: "배터리를 한 번 충전하면 얼마나 사용할 수 있나요?" 
                        },
                        { 
                            keywords: ['착용', '쓰', '입', '장착', '이용'], 
                            question: "엔젤슈트 H10은 어떻게 착용하나요?" 
                        },
                        { 
                            keywords: ['기능', '특징', '장점', '뭐', '어떤', '제품', '뭔'], 
                            question: "엔젤슈트 H10은 어떤 제품인가요?" 
                        },
                        { 
                            keywords: ['보증', 'AS', 'A/S', '수리', '고장', '기간'], 
                            question: "엔젤슈트 H10의 품질 보증 기간은 얼마나 되나요?" 
                        },
                        { 
                            keywords: ['앱', '어플', '연결', '동기화', '연동', '스마트폰', '폰'], 
                            question: "angel'a PRO 앱은 무엇을 하는 앱인가요?" 
                        },
                        { 
                            keywords: ['재질', '소재', '무엇으로', '만들', '뭐로'], 
                            question: "엔젤슈트 H10은 의료기기인가요?" 
                        },
                        { 
                            keywords: ['주의', '안전', '위험', '조심', '주의사항'], 
                            question: "엔젤슈트 H10 사용 시 가장 중요한 안전 수칙은 무엇인가요?" 
                        },
                        { 
                            keywords: ['구성품', '구성', '포함', '패키지', '세트', '박스'], 
                            question: "엔젤슈트 H10의 기본 구성품은 무엇인가요?" 
                        },
                        { 
                            keywords: ['사용설명서', '매뉴얼', '메뉴얼', '설명서', '다운로드', '다운'], 
                            question: "사용설명서는 어디서 볼 수 있나요?" 
                        }
                    ];
                    
                    // 간단한 질문 패턴 매칭
                    const userWords = userInput.split(/\s+/);
                    
                    // 1. 특수 케이스: 극단적으로 짧은 질문 (1-2단어)
                    if (userWords.length <= 2) {
                        // 가격 확인
                        if (userInput === "가격" || userInput === "얼마" || userInput === "비용") {
                            const priceQA = qaPairs.find(qa => qa.question === "가격이 얼마인가요?");
                            if (priceQA) {
                                console.log(`초단순 질문 매칭: "${userInput}" -> "가격이 얼마인가요?"`);
                                addMessage(priceQA.answer, true, priceQA.image);
                                return;
                            }
                        }
                        
                        // 무게 확인
                        if (userInput === "무게" || userInput === "몇키로" || userInput === "무게는") {
                            const weightQA = qaPairs.find(qa => qa.question === "엔젤슈트 H10의 무게는 얼마인가요?");
                            if (weightQA) {
                                console.log(`초단순 질문 매칭: "${userInput}" -> "무게 질문"`);
                                addMessage(weightQA.answer, true, weightQA.image);
                                return;
                            }
                        }
                        
                        // 배터리 확인
                        if (userInput === "배터리" || userInput === "충전") {
                            const batteryQA = qaPairs.find(qa => qa.question === "배터리를 한 번 충전하면 얼마나 사용할 수 있나요?");
                            if (batteryQA) {
                                console.log(`초단순 질문 매칭: "${userInput}" -> "배터리 질문"`);
                                addMessage(batteryQA.answer, true, batteryQA.image);
                                return;
                            }
                        }
                        
                        // 착용법 확인
                        if (userInput === "착용" || userInput === "방법" || userInput === "어떻게" || 
                            userInput === "착용방법" || userInput === "쓰는법" || userInput === "사용법") {
                            const wearingQA = qaPairs.find(qa => qa.question === "엔젤슈트 H10은 어떻게 착용하나요?");
                            if (wearingQA) {
                                console.log(`착용법 질문 매칭 성공, 이미지: ${wearingQA.image}`);
                                addMessage(wearingQA.answer, true, wearingQA.image);
                                return;
                            }
                        }
                    }
                    
                    // 2. 짧은 질문 패턴 매칭 (3단어 이하)
                    if (userWords.length <= 3) {
                        // 제품 구성품 질문 처리 (예: "제품 구성품은?", "구성품은?", "구성품")
                        if (userInput.includes('구성품') || 
                            (userInput.includes('구성') && userInput.includes('품')) ||
                            (userInput.includes('제품') && userInput.includes('구성'))) {
                            console.log("제품 구성품 질문 감지");
                            const componentsQA = qaPairs.find(qa => qa.question === "엔젤슈트 H10의 기본 구성품은 무엇인가요?");
                            if (componentsQA) {
                                console.log(`구성품 질문 매칭 성공`);
                                addMessage(componentsQA.answer, true, componentsQA.image);
                                return;
                            }
                        }
                        
                        for (const pattern of simplePatterns) {
                            for (const keyword of pattern.keywords) {
                                if (userInput.includes(keyword)) {
                                    // 일치하는 패턴을 찾으면 해당 질문에 매핑된 답변 찾기
                                    const matchedQA = qaPairs.find(qa => qa.question === pattern.question);
                                    if (matchedQA) {
                                        console.log(`단순 질문 패턴 매칭: "${userInput}" -> "${pattern.question}"`);
                                        addMessage(matchedQA.answer, true, matchedQA.image);
                                        return;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // 착용법 관련 질문에 즉시 응답
                if (userInput.includes('착용') || userInput.includes('방법') || userInput.includes('사용법') || 
                    userInput.includes('쓰는법') || userInput.includes('착용법') || userInput.includes('어떻게')) {
                    console.log("착용법 관련 질문 감지");
                    // 착용 방법 질문 매칭
                    const wearingQA = qaPairs.find(qa => qa.question === "엔젤슈트 H10은 어떻게 착용하나요?");
                    if (wearingQA) {
                        console.log(`착용법 질문 매칭 성공, 이미지: ${wearingQA.image}`);
                        addMessage(wearingQA.answer, true, wearingQA.image);
                        return;
                    }
                }
                
                if (directAnswer) {
                    // 즉시 응답이 가능한 경우
                    addMessage(directAnswer, true);
                    return;
                }
                
                // 즉시 응답이 불가능한 경우 로딩 메시지 표시
                const loadingMsgElement = addMessage("응답을 생성하는 중...", true);
                
                try {
                    // 로딩 메시지를 제거하고 미리 정의된 질문-답변 쌍에서 가장 적합한 답변 찾기
                    setTimeout(() => {
                        // 로딩 메시지 제거 - 모든 로딩 메시지를 찾아 제거
                        const loadingMessages = messagesContainer.querySelectorAll('.loading-message');
                        loadingMessages.forEach(msg => messagesContainer.removeChild(msg));
                        
                        // 미리 정의된 질문-답변 쌍에서 가장 적합한 답변 찾기
                        let bestMatch = null;
                        let bestImage = null;
                        let highestScore = 0;
                        
                        for (const qa of qaPairs) {
                            let matchScore = 0;
                            
                            // 단순 질문 처리 - 질문이 매우 짧은 경우 (5단어 이하) 정확한 키워드 매칭에 가중치 부여
                            const userWords = userInput.split(/\s+/);
                            const isSimpleQuestion = userWords.length <= 5;
                            
                            // 주요 키워드 매칭 (가중치 2)
                            for (const keyword of qa.keywords) {
                                if (userInput.includes(keyword)) {
                                    // 짧은 질문에서는 핵심 키워드 매칭에 더 높은 가중치 부여
                                    matchScore += isSimpleQuestion ? 3 : 2;
                                    
                                    // 정확한 키워드 매칭 (예: "배터리"라는 단어가 정확히 일치)
                                    if (userWords.includes(keyword)) {
                                        matchScore += isSimpleQuestion ? 2 : 1;
                                    }
                                }
                            }
                            
                            // 카테고리 매칭 (추가 가중치)
                            if (qa.category) {
                                const categoryWords = qa.category.toLowerCase().split(/\s+/);
                                for (const word of categoryWords) {
                                    if (userInput.includes(word)) {
                                        matchScore += 1.5;
                                    }
                                }
                            }
                            
                            // 추가 키워드 매칭 (질문에서 추출한 단어들)
                            const questionWords = qa.question.toLowerCase().replace(/[?!.,]/g, '').split(/\s+/);
                            for (const word of questionWords) {
                                if (word.length > 1 && userInput.includes(word)) {
                                    matchScore += 1;
                                    
                                    // 짧은 단어 정확히 매칭되는 경우 추가 가중치
                                    // (예: "전원", "앱" 등 중요 단어)
                                    if (word.length <= 3 && userWords.includes(word)) {
                                        matchScore += 1.5;
                                    }
                                }
                            }
                            
                            // 질문의 첫 부분에 더 높은 가중치 부여
                            // (예: "무게가 얼마인가요?"와 같은 질문에서 "무게"는 매우 중요)
                            const firstWords = qa.question.toLowerCase().replace(/[?!.,]/g, '').split(/\s+/).slice(0, 3);
                            for (const word of firstWords) {
                                if (word.length > 1 && userInput.includes(word)) {
                                    matchScore += 1;
                                }
                            }
                            
                            // 최고 점수 업데이트
                            if (matchScore > highestScore) {
                                highestScore = matchScore;
                                bestMatch = qa.answer;
                                bestImage = qa.image;
                            }
                        }
                        
                        // 적절한 응답 찾기
                        if (highestScore >= 2) {
                            // 충분히 관련성 있는 답변 찾음
                            addMessage(bestMatch, true, bestImage);
                        } else {
                            // 관련성 있는 답변을 찾지 못함
                            addMessage("죄송합니다. 질문에 대한 답변을 찾을 수 없습니다. 주요 기능, 배터리, 착용 방법 등에 대해 질문해 보세요.", true);
                        }
                    }, 1000);
                } catch (error) {
                    console.error("API 호출 오류:", error);
                    
                    // 로딩 메시지 제거 - 모든 로딩 메시지를 찾아 제거
                    const loadingMessages = messagesContainer.querySelectorAll('.loading-message');
                    loadingMessages.forEach(msg => messagesContainer.removeChild(msg));
                    
                    // 오류 발생 시 기본 응답
                    addMessage("죄송합니다. 응답을 생성하는 중에 오류가 발생했습니다. 다시 시도해 주세요.", true);
                }
            } catch (error) {
                console.error("전체 처리 오류:", error);
                addMessage("죄송합니다. 응답을 생성하는 중에 오류가 발생했습니다. 다시 시도해 주세요.", true);
            }
        });

        // 엔터키 처리를 위한 이벤트 리스너 추가
        messageInput.addEventListener('keydown', function(e) {
            // 엔터키가 눌렸을 때 폼 제출
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html> 